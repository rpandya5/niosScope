#include <stdlib.h>
#include <stdio.h>
#include <math.h>


volatile int* LEDs = 0xFF200000;
	
volatile int pixel_buffer_start; // global variable
short int Buffer1[240][512]; // 240 rows, 512 (320 + padding) columns
short int Buffer2[240][512];

int temp[16] = {0};
int murder_me[16] = {0};


#define XMAX 320
#define YMAX 240
	
/*#define BLUE 0x0000FF
#define RED 0xFF0000
#define PINK 0xFFC0CB
#define WHITE 0xFFFFFF
#define GREEN 0x00FF00 
#define YELLOW 0xFFFF00
#define PURPLE 0xA020F0
#define ORANGE 0xFFA500*/

#define BLUE 0xFFFFFF
#define RED 0xFFFFFF
#define PINK 0xFFFFFF
#define WHITE 0xFFFFFF
#define ORIGIN_X XMAX/2
#define ORIGIN_Y YMAX/2
#define SCALE 10.0  // Controls the spread of the sinc function
#define THRESHOLD 1.0  // Minimum intensity to consider a point
#define MAX_POINTS (XMAX * YMAX) // Maximum possible points
	

int points[766][2]={
    {0, 125},
    {0, 126},
    {0, 127},
    {1, 125},
    {1, 126},
    {2, 124},
    {2, 125},
    {3, 123},
    {3, 124},
    {3, 125},
    {4, 123},
    {4, 124},
    {5, 122},
    {5, 123},
    {6, 121},
    {6, 122},
    {6, 123},
    {7, 121},
    {7, 122},
    {8, 120},
    {8, 121},
    {9, 119},
    {9, 120},
    {10, 118},
    {10, 119},
    {10, 120},
    {11, 117},
    {11, 118},
    {11, 119},
    {12, 117},
    {12, 118},
    {13, 116},
    {13, 117},
    {14, 115},
    {14, 116},
    {15, 114},
    {15, 115},
    {16, 113},
    {16, 114},
    {16, 115},
    {17, 113},
    {17, 114},
    {18, 112},
    {18, 113},
    {19, 111},
    {19, 112},
    {20, 110},
    {20, 111},
    {20, 112},
    {21, 110},
    {21, 111},
    {22, 109},
    {22, 110},
    {23, 108},
    {23, 109},
    {23, 110},
    {24, 108},
    {24, 109},
    {25, 107},
    {25, 108},
    {26, 106},
    {26, 107},
    {26, 108},
    {27, 106},
    {27, 107},
    {28, 105},
    {28, 106},
    {28, 107},
    {29, 105},
    {29, 106},
    {30, 105},
    {30, 106},
    {31, 104},
    {31, 105},
    {31, 106},
    {32, 104},
    {32, 105},
    {33, 104},
    {33, 105},
    {34, 104},
    {34, 105},
    {35, 104},
    {35, 105},
    {36, 103},
    {36, 104},
    {36, 105},
    {37, 103},
    {37, 104},
    {37, 105},
    {38, 104},
    {38, 105},
    {39, 104},
    {39, 105},
    {40, 104},
    {40, 105},
    {41, 104},
    {41, 105},
    {41, 106},
    {42, 104},
    {42, 105},
    {42, 106},
    {43, 105},
    {43, 106},
    {44, 105},
    {44, 106},
    {44, 107},
    {45, 106},
    {45, 107},
    {46, 106},
    {46, 107},
    {46, 108},
    {47, 107},
    {47, 108},
    {48, 108},
    {48, 109},
    {49, 108},
    {49, 109},
    {49, 110},
    {50, 109},
    {50, 110},
    {50, 111},
    {51, 110},
    {51, 111},
    {52, 111},
    {52, 112},
    {53, 112},
    {53, 113},
    {54, 113},
    {54, 114},
    {55, 114},
    {55, 115},
    {56, 115},
    {56, 116},
    {57, 116},
    {57, 117},
    {57, 118},
    {58, 117},
    {58, 118},
    {58, 119},
    {59, 118},
    {59, 119},
    {59, 120},
    {60, 120},
    {60, 121},
    {61, 121},
    {61, 122},
    {62, 122},
    {62, 123},
    {62, 124},
    {63, 123},
    {63, 124},
    {63, 125},
    {64, 125},
    {64, 126},
    {65, 126},
    {65, 127},
    {66, 127},
    {66, 128},
    {66, 129},
    {67, 128},
    {67, 129},
    {67, 130},
    {68, 130},
    {68, 131},
    {69, 131},
    {69, 132},
    {70, 132},
    {70, 133},
    {71, 133},
    {71, 134},
    {71, 135},
    {72, 134},
    {72, 135},
    {72, 136},
    {73, 136},
    {73, 137},
    {74, 137},
    {74, 138},
    {75, 138},
    {75, 139},
    {76, 139},
    {76, 140},
    {77, 140},
    {77, 141},
    {78, 140},
    {78, 141},
    {78, 142},
    {79, 141},
    {79, 142},
    {79, 143},
    {80, 142},
    {80, 143},
    {81, 143},
    {81, 144},
    {82, 143},
    {82, 144},
    {82, 145},
    {83, 144},
    {83, 145},
    {84, 144},
    {84, 145},
    {85, 144},
    {85, 145},
    {85, 146},
    {86, 145},
    {86, 146},
    {87, 145},
    {87, 146},
    {88, 145},
    {88, 146},
    {89, 145},
    {89, 146},
    {90, 145},
    {90, 146},
    {91, 144},
    {91, 145},
    {91, 146},
    {92, 144},
    {92, 145},
    {93, 143},
    {93, 144},
    {93, 145},
    {94, 143},
    {94, 144},
    {95, 142},
    {95, 143},
    {96, 141},
    {96, 142},
    {96, 143},
    {97, 140},
    {97, 141},
    {97, 142},
    {98, 139},
    {98, 140},
    {99, 138},
    {99, 139},
    {100, 137},
    {100, 138},
    {101, 135},
    {101, 136},
    {101, 137},
    {102, 134},
    {102, 135},
    {103, 132},
    {103, 133},
    {104, 130},
    {104, 131},
    {104, 132},
    {105, 128},
    {105, 129},
    {105, 130},
    {106, 126},
    {106, 127},
    {106, 128},
    {107, 124},
    {107, 125},
    {107, 126},
    {108, 122},
    {108, 123},
    {109, 120},
    {109, 121},
    {110, 117},
    {110, 118},
    {110, 119},
    {111, 115},
    {111, 116},
    {112, 112},
    {112, 113},
    {112, 114},
    {113, 110},
    {113, 111},
    {114, 107},
    {114, 108},
    {115, 104},
    {115, 105},
    {116, 101},
    {116, 102},
    {116, 103},
    {117, 98},
    {117, 99},
    {117, 100},
    {118, 95},
    {118, 96},
    {118, 97},
    {119, 92},
    {119, 93},
    {119, 94},
    {120, 89},
    {120, 90},
    {121, 86},
    {121, 87},
    {122, 83},
    {122, 84},
    {123, 79},
    {123, 80},
    {123, 81},
    {124, 76},
    {124, 77},
    {124, 78},
    {125, 73},
    {125, 74},
    {126, 70},
    {126, 71},
    {127, 66},
    {127, 67},
    {127, 68},
    {128, 63},
    {128, 64},
    {128, 65},
    {129, 60},
    {129, 61},
    {130, 57},
    {130, 58},
    {131, 53},
    {131, 54},
    {131, 55},
    {132, 50},
    {132, 51},
    {132, 52},
    {133, 47},
    {133, 48},
    {133, 49},
    {134, 44},
    {134, 45},
    {135, 41},
    {135, 42},
    {136, 38},
    {136, 39},
    {137, 35},
    {137, 36},
    {137, 37},
    {138, 32},
    {138, 33},
    {138, 34},
    {139, 30},
    {139, 31},
    {140, 27},
    {140, 28},
    {141, 24},
    {141, 25},
    {141, 26},
    {142, 22},
    {142, 23},
    {143, 20},
    {143, 21},
    {144, 17},
    {144, 18},
    {144, 19},
    {145, 15},
    {145, 16},
    {146, 13},
    {146, 14},
    {147, 11},
    {147, 12},
    {147, 13},
    {148, 9},
    {148, 10},
    {148, 11},
    {149, 8},
    {149, 9},
    {150, 6},
    {150, 7},
    {150, 8},
    {151, 5},
    {151, 6},
    {152, 4},
    {152, 5},
    {153, 3},
    {153, 4},
    {154, 2},
    {154, 3},
    {155, 1},
    {155, 2},
    {156, 0},
    {156, 1},
    {156, 2},
    {157, 0},
    {157, 1},
    {158, 0},
    {158, 1},
    {159, 0},
    {159, 1},
    {160, 0},
    {160, 1},
    {161, 0},
    {161, 1},
    {162, 0},
    {162, 1},
    {163, 0},
    {163, 1},
    {163, 2},
    {164, 1},
    {164, 2},
    {165, 2},
    {165, 3},
    {166, 3},
    {166, 4},
    {167, 4},
    {167, 5},
    {168, 5},
    {168, 6},
    {169, 6},
    {169, 7},
    {169, 8},
    {170, 8},
    {170, 9},
    {171, 9},
    {171, 10},
    {171, 11},
    {172, 11},
    {172, 12},
    {172, 13},
    {173, 13},
    {173, 14},
    {174, 15},
    {174, 16},
    {175, 17},
    {175, 18},
    {175, 19},
    {176, 20},
    {176, 21},
    {177, 22},
    {177, 23},
    {178, 24},
    {178, 25},
    {178, 26},
    {179, 27},
    {179, 28},
    {180, 30},
    {180, 31},
    {181, 32},
    {181, 33},
    {181, 34},
    {182, 35},
    {182, 36},
    {182, 37},
    {183, 38},
    {183, 39},
    {184, 41},
    {184, 42},
    {185, 44},
    {185, 45},
    {186, 47},
    {186, 48},
    {186, 49},
    {187, 50},
    {187, 51},
    {187, 52},
    {188, 53},
    {188, 54},
    {188, 55},
    {189, 57},
    {189, 58},
    {190, 60},
    {190, 61},
    {191, 63},
    {191, 64},
    {191, 65},
    {192, 66},
    {192, 67},
    {192, 68},
    {193, 70},
    {193, 71},
    {194, 73},
    {194, 74},
    {195, 76},
    {195, 77},
    {195, 78},
    {196, 79},
    {196, 80},
    {196, 81},
    {197, 83},
    {197, 84},
    {198, 86},
    {198, 87},
    {199, 89},
    {199, 90},
    {200, 92},
    {200, 93},
    {200, 94},
    {201, 95},
    {201, 96},
    {201, 97},
    {202, 98},
    {202, 99},
    {202, 100},
    {203, 101},
    {203, 102},
    {203, 103},
    {204, 104},
    {204, 105},
    {205, 107},
    {205, 108},
    {206, 110},
    {206, 111},
    {207, 112},
    {207, 113},
    {207, 114},
    {208, 115},
    {208, 116},
    {209, 117},
    {209, 118},
    {209, 119},
    {210, 120},
    {210, 121},
    {211, 122},
    {211, 123},
    {212, 124},
    {212, 125},
    {212, 126},
    {213, 126},
    {213, 127},
    {213, 128},
    {214, 128},
    {214, 129},
    {214, 130},
    {215, 130},
    {215, 131},
    {215, 132},
    {216, 132},
    {216, 133},
    {217, 134},
    {217, 135},
    {218, 135},
    {218, 136},
    {218, 137},
    {219, 137},
    {219, 138},
    {220, 138},
    {220, 139},
    {221, 139},
    {221, 140},
    {222, 140},
    {222, 141},
    {222, 142},
    {223, 141},
    {223, 142},
    {223, 143},
    {224, 142},
    {224, 143},
    {225, 143},
    {225, 144},
    {226, 143},
    {226, 144},
    {226, 145},
    {227, 144},
    {227, 145},
    {228, 144},
    {228, 145},
    {228, 146},
    {229, 145},
    {229, 146},
    {230, 145},
    {230, 146},
    {231, 145},
    {231, 146},
    {232, 145},
    {232, 146},
    {233, 145},
    {233, 146},
    {234, 144},
    {234, 145},
    {234, 146},
    {235, 144},
    {235, 145},
    {236, 144},
    {236, 145},
    {237, 143},
    {237, 144},
    {237, 145},
    {238, 143},
    {238, 144},
    {239, 142},
    {239, 143},
    {240, 141},
    {240, 142},
    {240, 143},
    {241, 140},
    {241, 141},
    {241, 142},
    {242, 140},
    {242, 141},
    {243, 139},
    {243, 140},
    {244, 138},
    {244, 139},
    {245, 137},
    {245, 138},
    {246, 136},
    {246, 137},
    {247, 134},
    {247, 135},
    {247, 136},
    {248, 133},
    {248, 134},
    {248, 135},
    {249, 132},
    {249, 133},
    {250, 131},
    {250, 132},
    {251, 130},
    {251, 131},
    {252, 128},
    {252, 129},
    {252, 130},
    {253, 127},
    {253, 128},
    {253, 129},
    {254, 126},
    {254, 127},
    {255, 125},
    {255, 126},
    {256, 123},
    {256, 124},
    {256, 125},
    {257, 122},
    {257, 123},
    {257, 124},
    {258, 121},
    {258, 122},
    {259, 120},
    {259, 121},
    {260, 118},
    {260, 119},
    {260, 120},
    {261, 117},
    {261, 118},
    {261, 119},
    {262, 116},
    {262, 117},
    {262, 118},
    {263, 115},
    {263, 116},
    {264, 114},
    {264, 115},
    {265, 113},
    {265, 114},
    {266, 112},
    {266, 113},
    {267, 111},
    {267, 112},
    {268, 110},
    {268, 111},
    {269, 109},
    {269, 110},
    {269, 111},
    {270, 108},
    {270, 109},
    {270, 110},
    {271, 108},
    {271, 109},
    {272, 107},
    {272, 108},
    {273, 106},
    {273, 107},
    {273, 108},
    {274, 106},
    {274, 107},
    {275, 105},
    {275, 106},
    {275, 107},
    {276, 105},
    {276, 106},
    {277, 104},
    {277, 105},
    {277, 106},
    {278, 104},
    {278, 105},
    {278, 106},
    {279, 104},
    {279, 105},
    {280, 104},
    {280, 105},
    {281, 104},
    {281, 105},
    {282, 103},
    {282, 104},
    {282, 105},
    {283, 103},
    {283, 104},
    {283, 105},
    {284, 104},
    {284, 105},
    {285, 104},
    {285, 105},
    {286, 104},
    {286, 105},
    {287, 104},
    {287, 105},
    {288, 104},
    {288, 105},
    {288, 106},
    {289, 105},
    {289, 106},
    {290, 105},
    {290, 106},
    {291, 105},
    {291, 106},
    {291, 107},
    {292, 106},
    {292, 107},
    {293, 106},
    {293, 107},
    {293, 108},
    {294, 107},
    {294, 108},
    {295, 108},
    {295, 109},
    {296, 108},
    {296, 109},
    {296, 110},
    {297, 109},
    {297, 110},
    {298, 110},
    {298, 111},
    {299, 110},
    {299, 111},
    {299, 112},
    {300, 111},
    {300, 112},
    {301, 112},
    {301, 113},
    {302, 113},
    {302, 114},
    {303, 113},
    {303, 114},
    {303, 115},
    {304, 114},
    {304, 115},
    {305, 115},
    {305, 116},
    {306, 116},
    {306, 117},
    {307, 117},
    {307, 118},
    {308, 117},
    {308, 118},
    {308, 119},
    {309, 118},
    {309, 119},
    {309, 120},
    {310, 119},
    {310, 120},
    {311, 120},
    {311, 121},
    {312, 121},
    {312, 122},
    {313, 121},
    {313, 122},
    {313, 123},
    {314, 122},
    {314, 123},
    {315, 123},
    {315, 124},
    {316, 123},
    {316, 124},
    {316, 125},
    {317, 124},
    {317, 125},
    {318, 125},
    {318, 126},
    {319, 125},
    {319, 126},
    {319, 127},
};
; // Array to store (x, y) coordinates
int count = 0;

void plot_pixel(int x, int y, short int line_color);

float sinc(float r) {
    return (r == 0) ? 1.0 : sin(M_PI * r) / (M_PI * r);
}

int main(void){
    volatile int * pixel_ctrl_ptr = (int *)0xFF203020;
    // declare other variables(not shown)
    // initialize location and direction of rectangles(not shown)
    /* set front pixel buffer to Buffer 1 */
    *(pixel_ctrl_ptr + 1) = (int) &Buffer1; // first store the address in the  back buffer
    /* now, swap the front/back buffers, to set the front buffer location */
    wait_for_vsync();
    /* initialize a pointer to the pixel buffer, used by drawing functions */
    pixel_buffer_start = *pixel_ctrl_ptr;
    clear_screen(); // pixel_buffer_start points to the pixel buffer

    /* set back pixel buffer to Buffer 2 */
    *(pixel_ctrl_ptr + 1) = (int) &Buffer2;
    pixel_buffer_start = *(pixel_ctrl_ptr + 1); // we draw on the back buffer
    clear_screen(); // pixel_buffer_start points to the pixel buffer
    /*for (int y = 0; y < YMAX; y++) {
		*(LEDs)=0x2;
        for (int x = 0; x < XMAX; x++) {
            float x_rel = (x - ORIGIN_X);
            float y_rel = (ORIGIN_Y-y);
            //float r = sqrt(x_rel * x_rel + y_rel * y_rel);
            int value = (int)(150 * sinc(x_rel));
            
            if ((abs(y_rel - value) > THRESHOLD*3.0) && (count < MAX_POINTS)) {  // Only include significant points
                points[count][0] = x;
                points[count][1] = y;
				//plot_pixel(x, y, WHITE);
                count++;
            }
        }
    }*/
    while (1)
    {
		*(LEDs)=0x1;
    	clear_screen(); // pixel_buffer_start points to the pixel buffer
		update();
		//compress();
        // code for drawing the boxes and lines (not shown)
        // code for updating the locations of boxes (not shown)
        wait_for_vsync(); // swap front and back buffers on VGA vertical sync
        pixel_buffer_start = *(pixel_ctrl_ptr + 1); // new back buffer
    }
}

// code for subroutines (not shown)


void wait_for_vsync(){
    volatile int * pixel_ctrl_ptr = (int *)0xFF203020;
	*pixel_ctrl_ptr = 1;
	while((*(pixel_ctrl_ptr+3))&0x1){}

}

void plot_pixel(int x, int y, short int line_color)
{
    volatile short int *one_pixel_address;
        
        one_pixel_address = pixel_buffer_start + (y << 10) + (x << 1);
        
        *one_pixel_address = line_color;
}

void clear_screen(){
	for (int i=0; i<XMAX; i++){
		for(int j=0; j<YMAX; j++){
			plot_pixel(i,j,0);	
		}
	}
}

void update(){
	for (int i=0; i < 766; i++){
		plot_pixel(points[i][0],points[i][1], WHITE);
	}

	for (int i=0; i < 766; i++){
		plot_pixel(points[i][0]/2+XMAX/4,points[i][1], RED);
	}
	for (int i=0; i < 766; i++){
		// the linear offset I believe is needed because of rounding errors, I think I will need a second list for the larger SINC
		plot_pixel(points[i][0]*2+XMAX+30,points[i][1], BLUE);
	}
	/*for(int i=0; i<XMAX; i++){
		plot_pixel(i, YMAX/2+50 - 150.0*sinc(XMAX/2-i), WHITE);
	}*/


}
